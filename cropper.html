<script src="https://unpkg.com/vue@next"></script>
<script src="https://unpkg.com/vue-advanced-cropper@^2.0.0/dist/index.umd.js" />
<link rel="stylesheet" href="https://unpkg.com/vue-advanced-cropper@^2.0.0/dist/style.css" />


<script src="https://unpkg.com/vue@next"></script>
<script src="https://unpkg.com/vue-advanced-cropper@^2.0.0"></script>
<link rel="stylesheet" href="https://unpkg.com/vue-advanced-cropper@^2.0.0/dist/style.css" />

<div id="app">
  <cropper
    :src="img"
    @change="change"
    ref="cropper"
  ></cropper>
  <button @click="crop">
		Crop
	</button>
</div>

<script>
  // https://gist.github.com/davalapar/d0a5ba7cce4bc599f54800da22926da2
  function downloadFile(data, filename, mime) {
  // It is necessary to create a new blob object with mime-type explicitly set
  // otherwise only Chrome works like it should
  const blob = new Blob([data], {type: mime || 'application/octet-stream'});
  if (typeof window.navigator.msSaveBlob !== 'undefined') {
    // IE doesn't allow using a blob object directly as link href.
    // Workaround for "HTML7007: One or more blob URLs were
    // revoked by closing the blob for which they were created.
    // These URLs will no longer resolve as the data backing
    // the URL has been freed."
    window.navigator.msSaveBlob(blob, filename);
    return;
  }
  // Other browsers
  // Create a link pointing to the ObjectURL containing the blob
  const blobURL = window.URL.createObjectURL(blob);
  const tempLink = document.createElement('a');
  tempLink.style.display = 'none';
  tempLink.href = blobURL;
  tempLink.setAttribute('download', filename);
  // Safari thinks _blank anchor are pop ups. We only want to set _blank
  // target if the browser does not support the HTML5 download attribute.
  // This allows you to download files in desktop safari if pop up blocking
  // is enabled.
  if (typeof tempLink.download === 'undefined') {
    tempLink.setAttribute('target', '_blank');
  }
  document.body.appendChild(tempLink);
  tempLink.click();
  document.body.removeChild(tempLink);
  setTimeout(() => {
    // For Firefox it is necessary to delay revoking the ObjectURL
    window.URL.revokeObjectURL(blobURL);
  }, 100);
}

</script>


<script>
app = Vue.createApp({
  data() {
    const img_url = '/preview';
    const self = this;
    const img = new Image();
    img.src = img_url;
    img.onload = function() {
      document.body.appendChild(img); // You can get the image ratio without inserting the image in body
      self.image_sizes = {width: img.width, height: img.height};
      document.body.removeChild(img);
   }
    return {
      page: 0,
      max_page: 0,
      pdf: 'sample.pdf',
      img: img_url,
      image: {
        width: 0,
        height: 0
      },
      coordinates: {
				width: 0,
				height: 0,
				left: 0,
				top: 0,
			},
    }
  },
  methods: {
    change({coordinates, canvas}) {
      console.log(coordinates, canvas)
      this.coordinates = coordinates
    },
    crop() {
			// const { coordinates, canvas, } = this.$refs.cropper.getResult();
			// this.coordinates = coordinates;

			// You able to do different manipulations at a canvas
			// but there we just get a cropped image, that can be used
			// as src for <img/> to preview result
			// this.image = canvas.toDataURL();
			// upload
      const {
	      coordinates, imageTransforms, visibleArea, canvas
      } = this.$refs.cropper.getResult();
      console.log({
	      coordinates, imageTransforms, visibleArea, canvas
      });
      const form = new FormData();
      // form.append('coordinates', this.coordinates);
      fetch('/crop', {
						method: 'POST',
						body: JSON.stringify({ coordinates: this.coordinates, image: this.image_sizes }),
						// body: form,
      }).then(function(response) {
        console.log(response);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response;
      }).then(function(response) {
        console.log('2');
         return response.json();
         /* {
          "filename": "foobar.pdf",
          "base64": "a4f5fe3290f===",
        } */
      }).then(function(data) {
        console.log('3');
        console.log(data);
        const byteCharacters = atob(data.base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        // const blob = new Blob([byteArray], {type: contentType});
        // let objectURL = URL.createObjectURL(blob);
        // myImage.src = objectURL;
        downloadFile(byteArray, data.filename, 'application/pdf');
      });
		},
  },
  components: {
  	Cropper: VueAdvancedCropper.Cropper
  }
}).mount('#app')
</script>
